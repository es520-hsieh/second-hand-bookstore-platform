<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- fontawesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
        integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
    <!-- js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"></script>
    <!-- cookie -->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script src="./statics/js/cookie.js"></script>

    <title>SA</title>
    <style>
        body {
            background-color: #f3f3f3;
        }

        .navbar-brand,
        .nav-item>a {
            color: white !important;
        }

        .dropdown-item {
            color: black;
        }

        .col-12>h1 {
            font-weight: bold;
        }

        .box {
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f3f3f3;
        }

        .slider-ui {
            position: relative;
            width: 500px;
            height: 50px;
            margin: 30px 0;
        }

        .slider-ui input {
            position: absolute;
            z-index: 10;
            top: 0;
            left: 0;
            bottom: 0;
            width: 100%;
            cursor: pointer;
            opacity: 0;
        }

        .slider-ui .bar {
            position: absolute;
            z-index: 1;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background-color: #000;
            border-radius: 50px;
            box-shadow: 0 5px 0 rgba(0, 0, 0, .1);
        }

        .slider-ui .min,
        .slider-ui .max {
            position: absolute;
            z-index: 2;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            font-weight: 800;
            color: #fff;
        }

        .slider-ui .min {
            left: 2%;
        }

        .slider-ui .max {
            right: 2%;
        }

        .slider-ui .track {
            position: absolute;
            z-index: 3;
            left: 25px;
            right: 25px;
            top: 0;
            bottom: 0;
        }

        .slider-ui .value {
            position: absolute;
            left: 50%;
            top: 0;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: 800;
            color: #fff;
            background-color: #fff;
            border: 4px solid #000;
            border-radius: 100%;
            box-sizing: border-box;
            transform: translateX(-50%);
            transition: top .3s ease-in-out, color .3s ease-in-out;
        }

        .slider-ui .value.up {
            top: -110%;
            color: #000;
        }

        .slider-ui.color1 .bar {
            background-color: #00b894;
        }

        .slider-ui.color1 .value {
            border-color: #00b894;
        }

        .btn-circle {
            border-radius: 1.875rem;
            font-weight: bold;
            width: 100px;
            text-align: center;
            margin: 0.5rem;
            padding: 1rem;
            height: 3.5rem;
            font-size: 14px;
        }

        .cart {
            color: #fff;
        }

        input.form-control {
            width: 18ch;
            margin: auto;
        }

        img {
            max-height: 400px;
            max-width: 250px;
        }
    </style>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-md navbar-light" style="background-color: #33691e;">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">今年中於不遭央</a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav ms-auto mb-2 mb-lg-0" style="justify-content: end;">
                        <li class="nav-item"></li>
                        <a class="nav-link active align-middle" href="cart.html"><i
                                class="fas fa-shopping-cart cart p-0"></i></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="product.html">商品</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="help.html">顧客中心</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="contact.html">聯繫</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                個人專區
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown"
                                style="color: black;">
                                <li><a class="dropdown-item" href="register.html">註冊</a></li>
                                <li><a class="dropdown-item" href="login.html">登入</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="personal.html">個人資訊</a></li>
                                <li><a class="dropdown-item" href="order.html">訂單資訊</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="">登出</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>
    <main>
        <div class="container">
            <div class="row justify-content-center text-center m-2 align-items-center">
                <div style="height: 50px;"></div>
                <div class="col-12">
                    <h1>議價</h1>
                </div>

                <div class="col-md-6 col-lg-4">
                    <img class="my-3"
                        src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSX7S9NIq7il4jC1NA2L27z4NMtY9cXKyUqYA&usqp=CAU"
                        alt="...">
                    <h2 id="product_name">循環台灣</h2>
                </div>
                <div class="col-md-6 col-lg-8">
                    <div class="row justify-content-center text-center m-2 align-items-center">
                        <h3 class="final p-3 col-md-4 col-lg-6"
                            style="background-color: rgba(204, 204, 204, 0.7); margin: auto;">最終價格:</h3>
                        <div class="group col-md-8 col-lg-6">
                            <a class="send btn btn-circle" style="color: white;background-color: #33691e">一鍵送出</a>
                            <a class="reject btn btn-circle" style="border-color: #33691e;">一鍵拒絕</a>
                        </div>
                    </div>

                    <h3 class="mt-5" id="customerPrices"></h3>
                    <div class="box">
                        <div class="slider-ui color1">
                            <input id="price_slider" type="range" step="1">
                            <div class="bar">
                                <span class="min"></span>
                                <span class="max"></span>
                            </div>
                            <div class="track">
                                <div class="value"></div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class='mt-2'></div>
                <div class="bargainTable col-12">

                </div>

            </div>
        </div>


    </main>

    <script>
        //如果不是member&supplier，看不到此頁面(買家回覆議價)
        //console.log(getCookie("type"))
        if (getCookie("type") != 1) {
        	if (getCookie("type") == 3) {
           	    alert('請先驗證會員，才可使用議價功能');
                location.href = "verify.html";
             }
            else if(getCookie("type") == 2){
                location.href = "adminList.html";
            }
            else{
                var yes = confirm('要登入嗎？');
                if (yes) {
                    location.href = "login.html";
                } else {
                    location.href = "product.html";
                }
            }
        }

        //const
        const BargainTable = document.querySelector(".bargainTable") //table
        const url = new URL(window.location) //url
        const supplier = getCookie("id") //supplier_id
        const product = url.searchParams.get("product")  //product_id
        let final_value = 0 // for group send, 取最終價格
        let data = null
        let lb = 1000 // low 買家區間
        let ub = 0 // up 買家區間
        let time = 1000 // timeout
        // call


        /** dynamic html **/
        document.querySelector('#dynamic_html')
        function getSellerBargain() {
            return new Promise((resolve, reject) => {
                $.ajax({
                    type: "GET",
                    url: "api/bargain.do?" + $.param({ "supplier_id": supplier, "product_id": product }),
                    crossDomain: true,
                    cache: false,
                    dataType: 'json',
                    timeout: 500,
                    success: function (response) {
                        if (response.status == 200) {
                            getBargainInfo(response.response);
                            data = response.response.data
                            //console.log(data)
                        }
                        console.log(response);
                    },
                    error: function () {
                        alert("無法連線到伺服器！");
                    }
                });

                // 因為要等表格載入才能掛event listener，做async在run()
                setTimeout(() => {
                    resolve();
                    ;
                }, 500
                );
            });

        }

        function getBargainInfo(data) {
            let datas = data.data
            //header
            let htmlContent = `
            <table class="table">
                <thead>
                    <tr>
                        <th>買家</th>
                        <th>議價區間</th>
                        <th>最終價格</th>
                        <th>送出/拒絕</th>
                    </tr>
                </thead>
                <tbody>`

            /* set bargain info & find (lb, ub) */
            // body
            $.each(datas, function (key, value) {
                //set (lb, ub)
                if (value['lower_limit'] < lb) { lb = value['lower_limit'] }
                if (value['upper_limit'] > ub) { ub = value['upper_limit'] }

                //set bargain info
                htmlContent += `
                    <tr>
                    <td>` + value['customer_id'] + `</td>
                    <td>` + value['lower_limit'] + `~` + value['upper_limit'] + `</td>`
                if (value['final_price'] == 0 && value['is_rejected'] == 'n') { // if is NOT bargained
                    htmlContent += `<td> 
                        <input class="form-control" type="number" value="${value['lower_limit']}"/> 
                    </td>`
                    htmlContent += `<td>
                        <button class="btn btn-sm btn-success">O</button>
                        <button class="btn btn-sm btn-danger">X</button>
                    </td>`
                } else if (value['final_price'] !== 0) { // final sended
                    htmlContent += `<td> <input class="form-control" type="number" value="${value['final_price']}" readonly/> </td>`
                    htmlContent += `<td>已送出</td>`
                } else { // rejected
                    htmlContent += `<td> <input class="form-control" type="number" value="X" readonly/> </td>`
                    htmlContent += `<td>已拒絕</td>`

                }
            })

            // footer
            htmlContent += `
                    </tr>
                </tbody>
            </table>`
            document.querySelector('.bargainTable').innerHTML = htmlContent

            //set customer prices
            document.querySelector('#customerPrices').innerText = `買家綜合區間: ${lb}~${ub}`
            document.querySelector("#price_slider").min = lb
            document.querySelector("#price_slider").max = ub
            document.querySelector(".min").innerText = lb;
            document.querySelector(".max").innerText = ub;

            //set productInfo
            document.querySelector('img').src = data.src[0]
            document.querySelector('#product_name').innerHTML = data.product.name
        }

        /** seller put **/
        // accept
        function setSellerAccept(customer, product, finalPrice) {
            var customer_id = customer
            var product_id = product
            var final_price = finalPrice
            // 打包成JSON
            var data_object = {
                "customer_id": customer_id,
                "product_id": product_id,
                "final_price": final_price
            }
            // 將JSON格式轉換成字串
            var data_string = JSON.stringify(data_object);

            $.ajax({
                type: "PUT",
                url: "api/bargain.do",
                data: data_string,
                crossDomain: true,
                cache: false,
                dataType: 'json',
                timeout: 500,
                success: function (response) {
                    if (response.status == 200) {
                        //updateHTML(response.response.data);
                        alert("已送出最終議價價格");
                    }
                    console.log(response);
                },
                error: function () {
                    alert("無法連線到伺服器！");
                }
            });
        }

        // reject
        function setSellerReject(customer, product) {
            var customer_id = customer
            var product_id = product
            // 打包成JSON
            var data_object = {
                "customer_id": customer_id,
                "product_id": product_id,
                "final_price": 0,
            }
            // 將JSON格式轉換成字串
            var data_string = JSON.stringify(data_object);

            $.ajax({
                type: "PUT",
                url: "api/bargain.do",
                data: data_string,
                crossDomain: true,
                cache: false,
                dataType: 'json',
                timeout: 500,
                success: function (response) {
                    if (response.status == 200) {
                        //updateHTML(response.response.data);
                        alert("已拒絕議價");
                    }
                    console.log(response);
                },
                error: function () {
                    alert("無法連線到伺服器！");
                }
            });
        }

        /** event listener**/
        // individaul //useless
        function sendbtn(event) {
            let target = event.target
            console.log(target)
            let coustomer = target.parentElement.children[0]
            let product = target.parentElement.children[1]
            /* send */
            if (target.classList.contains('btn-success')) {
                let finalPrice = target.parentElement.parentElement.children[2].children[0].value
                console.log(finalPrice)

                //setSellerBargain(customer, product, finalPrice)
            } else if (target.classList.contains('btn-danger')) {
                //setSellerBargain(customer, product)
            }
        }

        // all

        /** call function **/
        async function run() {
            await getSellerBargain()
            const tbody = document.querySelector("tbody")
            const groupbtn = document.querySelector(".group")
            /** event listener**/
            // individaul
            tbody.addEventListener('click', function (event) {
                let target = event.target
                let customer = target.parentElement.parentElement.children[0].innerText
                /* send */
                if (target.classList.contains('btn-success')) {
                    let finalPrice = target.parentElement.parentElement.children[2].children[0].value
                    var r = confirm("確認送出最終議價價格!\n送出即不得更改")
                    if (r == true) {
                        setSellerAccept(customer, product, finalPrice)
                        target.parentElement.children[0].disabled = true
                        target.parentElement.children[1].disabled = true
                        target.parentElement.parentElement.children[2].children[0].readOnly = true
                    }

                } else if (target.classList.contains('btn-danger')) {
                    var r = confirm("確認拒絕該買家的議價請求!\n送出即不得更改")
                    if (r == true) {
                        setSellerReject(customer, product)
                        target.parentElement.children[0].disabled = true
                        target.parentElement.children[1].disabled = true
                        target.parentElement.parentElement.children[2].children[0].value = null
                        target.parentElement.parentElement.children[2].children[0].readOnly = true
                    }
                }
                setTimeout(() => { getSellerBargain() }, time);
                time += 500

            })
            // all
            groupbtn.addEventListener('click', function (event) {
                let target = event.target
                if (target.classList.contains('send')) {
                    var r = confirm("***若議價區間不包含最終價格則拒絕***\n一鍵送出最終議價價格!\n送出即不得更改")
                    if (r == true) {
                        groupAccept(data)
                    }
                } else if (target.classList.contains('reject')) {
                    var r = confirm("一鍵拒絕議價!\n送出即不得更改")
                    if (r == true) {
                        groupReject(data)
                    }
                }
            })


        }
        function groupAccept(data) {
            $.each(data, function (key, value) {
                let customer_id = value['customer_id']
                let product_id = value['product_id']
                console.log(customer_id)
                console.log(product_id)
                let finalPrice = final_value

                let lower = value['lower_limit']
                //console.log(lower)
                let upper = value['upper_limit']
                //console.log(upper)
                if (value['final_price'] == 0 && value['is_rejected'] == 'n' && (lower <= final_value <= upper)) {
                    setTimeout(() => { setSellerAccept(customer_id, product_id, finalPrice) }, time);
                    time += 500
                } else if (value['final_price'] == 0 && value['is_rejected'] == 'n') {
                    setTimeout(() => { setSellerReject(customer_id, product_id) }, time);
                    time += 500
                }
            })
            setTimeout(() => { getSellerBargain() }, time);
            time += 500
        }
        function groupReject(data) {
            $.each(data, function (key, value) {
                if (value['final_price'] == 0 && value['is_rejected'] == 'n') {
                    let customer_id = value['customer_id']
                    let product_id = value['product_id']

                    setTimeout(() => { setSellerReject(customer_id, product_id) }, time);
                    time += 500
                }
            })
            setTimeout(() => { getSellerBargain() }, time);
            time += 500
        }

        /** slider set **/
        const sliders = document.querySelectorAll(".slider-ui");

        sliders.forEach(slider => {
            let input = slider.querySelector("input[type=range]");
            let min = input.getAttribute("min");
            let max = input.getAttribute("max");
            let valueElem = slider.querySelector(".value");
            slider.querySelector(".min").innerText = min;
            slider.querySelector(".max").innerText = max;

            function setValueElem() {
                valueElem.innerText = input.value;
                let percent = (input.value - min) / (max - min) * 100;
                valueElem.style.left = percent + "%";
                $('.final').text('最終價格: ' + input.value)
                final_value = input.value // for group send
            }
            setValueElem();

            input.addEventListener("input", setValueElem);
            input.addEventListener("mousedown", () => {
                valueElem.classList.add("up");
            });
            input.addEventListener("mouseup", () => {
                valueElem.classList.remove("up");
            });
        });
        run()
    </script>
</body>

</html>