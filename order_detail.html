<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link href="statics/css/bootstrap.min.css" rel="stylesheet">

  <!-- fontawesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
    integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
  <title>SA</title>
  <!--
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
  <meta name="generator" content="Jekyll v3.8.5">
  -->
  <!--
  <title>訂單詳情 ｜ NCU MIS SA</title>
  -->
  <!-- Bootstrap core CSS -->
  <!--
    <link href="statics/css/bootstrap.min.css" rel="stylesheet">
    <link href="statics/css/font-awesome.min.css" rel="stylesheet">
    <link href="statics/icon/favicon.ico" type="image/x-icon" rel="icon">
    <link href="statics/icon/favicon.ico" type="image/x-icon" rel="shortcut icon">
  -->

  <style>
    body {
      background-color: #f3f3f3;
    }

    .navbar-brand,
    .nav-item>a {
      color: white !important;
    }

    .col-12>h1 {
      font-weight: bold;
      font-size: 2em
    }

    .container {
      font-weight: normal;
    }

    .cart {
      color: #fff;
    }
  </style>
  <!-- Custom styles for this template 
  <link href="statics/css/product.css" rel="stylesheet">
  <link href="statics/css/jquery-confirm.css" rel="stylesheet">
  -->
  <!-- <script src="statics/js/jquery-3.4.1.min.js"></script>
  <script src="statics/js/jquery-confirm.js"></script>
  <script src="statics/js/big.min.js"></script> -->

</head>

<body>
  <header>
    <nav class="navbar navbar-expand-md navbar-light" style="background-color: #33691e;">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">今年中於不遭央</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0" style="justify-content: end;">
            <li class="nav-item"></li>
            <a class="nav-link active align-middle" href="cart.html"><i class="fas fa-shopping-cart cart p-0"></i></a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="product.html">商品</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="help.html">顧客中心</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="contact.html">聯繫</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown"
                aria-expanded="false">
                個人專區
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown" style="color: black;">
                <li><a class="dropdown-item" href="register.html">註冊</a></li>
                <li><a class="dropdown-item" href="login.html">登入</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="personal.html">個人資訊</a></li>
                <li><a class="dropdown-item" href="order.html">訂單資訊</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="">登出</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <div class="row justify-content-center text-center m-2">
    <div style="height: 50px;"></div>
    <div class="col-12">
      <h1><b>訂單詳情</h1>
      <p>以下為該筆訂單之所有資料</p>
    </div>
  </div>
  </div>

  <div class="container">
    <div class="pt-2 pb-5">
      <div class="my-3 p-3 rounded box-shadow">
        <h6 class="border-bottom border-gray pb-2 mb-0">訂單資料</h6>

        <div class="row">
          <div class="col media text-muted pt-3">
            <p class="media-body pb-3 mb-0 lh-125 border-bottom border-gray">
              <strong class="d-block text-gray-dark">訂單編號</strong>
              <span id="order_id">{{order_id}}</span>
            </p>
          </div>

          <div class="col media text-muted pt-3">
            <p class="media-body pb-3 mb-0 lh-125 border-bottom border-gray">
              <strong class="d-block text-gray-dark">貨號</strong>
              <span id="shipping">{{shipping}}</span>
            </p>
          </div>

          <div class="col media text-muted pt-3">
            <p class="media-body pb-3 mb-0 lh-125 border-bottom border-gray">
              <strong class="d-block text-gray-dark">建立日期</strong>
              <span id="create">{{create}}</span>
            </p>
          </div>
        </div>

        <div class="row">
          <div class="col media text-muted pt-3">
            <p class="media-body pb-3 mb-0 lh-125 border-bottom border-gray">
              <strong class="d-block text-gray-dark">姓名</strong>
              <span id="name" class="p-2">{{name}}</span>
            </p>
          </div>

          <div class="col media text-muted pt-3">
            <p class="media-body pb-3 mb-0 lh-125 border-bottom border-gray">
              <strong class="d-block text-gray-dark">手機號碼</strong>
              <span id="phone">{{phone}}</span>
            </p>
          </div>

          <div class="col media text-muted pt-3">
            <p class="media-body pb-3 mb-0 lh-125 border-bottom border-gray">
              <strong class="d-block text-gray-dark">電子郵件</strong>
              <span id="email">{{email}}</span>
            </p>
          </div>
        </div>

        <div class="media text-muted pt-3">
          <p class="media-body pb-3 mb-0 lh-125 border-bottom border-gray">
            <strong class="d-block text-gray-dark">超商取貨門市</strong>
            <span id="address">{{address}}</span>
          </p>
        </div>

        <div class="row">
          <div class="col media text-muted pt-3">
            <p class="media-body pb-3 mb-0 lh-125 border-bottom border-gray">
              <strong class="d-block text-gray-dark">項目數量</strong>
              <span id="item">{{item}}</span>
            </p>
          </div>

          <div class="col media text-muted pt-3">
            <p class="media-body pb-3 mb-0 lh-125 border-bottom border-gray">
              <strong class="d-block text-gray-dark">商品總數</strong>
              <span id="quantity">{{quantity}}</span>
            </p>
          </div>
        </div>

        <H3 class="d-block text-right mt-3">總價：$ <span id="total">{{total}}</span></H3>
      </div>


      <div class="table-responsive">
        <table id="table" class="table table-striped table-sm">
          <thead>
            <tr>
              <th class="text-center" style="width: 10%">商品編號</th>
              <th class="text-center" style="width: 40%">商品名稱</th>
              <th class="text-center" style="width: 15%">單價</th>
              <th class="text-center" style="width: 10%">數量</th>
              <th class="text-center" style="width: 15%">小計</th>
            </tr>
          </thead>
          <tbody id="panel">
          </tbody>
        </table>
      </div>
    </div>
  </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script src="./statics/js/cookie.js"></script>
    <script src="statics/js/big.min.js"></script>

    <script>
    //取得網址參數
    var url_string = window.location.href;
    var url = new URL(url_string);
    var id = url.searchParams.get("id");
    var member_id;
    $(document).ready(function(){
        if(getCookie("type") == 1 || getCookie("type") == 2){
            function getOrderData() {
                $.ajax({
                    type: "GET",
                    url: "api/order.do",
                    data: "id=" + id,
                    crossDomain: true,
                    cache: false,
                    dataType: 'json',
                    timeout: 5000,
                    success: function (response) {
                        if (response.status == 200) {
                            updateHTML(response.response.data);
                            updateCustomer(response.member.data[0]);
                        }
                        console.log(response)
                    },
                    error: function () {
                    alert("無法連線到伺服器！");
                    }
                });
            }

            getOrderData();
            function updateHTML(data) {
                member_id = data['order_info']['customer_id']
                $("#order_id").html(data['order_info']['order_id']);
                $("#create").html(data['order_info']['created_at']);
                $("#shipping").html(data['order_info']['shipping_code']);
                $("#email").html(data['order_info']['email']);
                $("#address").html(data['order_info']['address']);
                $("#phone").html(data['order_info']['phone']);
                $("#name").html(data['order_info']['name']);
                $("#item").html(data.product_info.length);

                var total_price = Big(0.0);
                var quantity = 0;
                var inner_html = "";

                $.each(data.product_info, function (k, v) {
                    console.log(v);
                    quantity += v['product_num'];
                    total_price = total_price.plus(v['subtotal']);
                    inner_html += updateOrderProductTable(v);
                });

                $("#quantity").html(quantity);
                $("#total").html(total_price.toString());

                $("#table > tbody").empty();
                $("#panel").append(inner_html);


            }

            function updateCustomer(member){
                $("#name").text(member.name);

                $("#phone").text(member.phone);
                $("#email").text(member.email);
                $("#name").text(member.name);
            }

            function updateOrderProductTable(data) {
                var table_html = "";
                table_html += '<tr id="row_' + data.id + '">';
                table_html += '<td class="align-middle text-center">' + data.product.product_id + '</td>';
                table_html += '<td class="align-middle"><p class="text-break">' + data.product.name + '</p></td>';
                table_html += '<td class="align-middle text-center"><span id="price_' + data.product_id + '">' + data.product_price + '</td>';
                table_html += '<td class="align-middle text-center">' + data.product_num + '</td>';
                table_html += '<td class="align-middle text-center"><strong><span id="subtotal_' + data.product_id + '">' + data.subtotal + '<strong></td>';
                table_html += '</tr>';

                return table_html;

            }
        }else if (getCookie("type") == 3) {
    		location.href = "verify.html";
        }else{
            location.href == "product.html";
        }
    })
    </script>

    <footer class="text-muted">
        <div class="container">
        <p class="text-center">
            <a href="#">Back to top</a>
        </p>
        </div>
    </footer>
</body>

</html>